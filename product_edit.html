<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>제이씨메디칼(JCMedical)</title>
  <meta name="description" content="제이씨메디칼(JCMedical, JC메디칼) 오스테오시스, 마인드레이 전문 대리점">
  <meta name="keywords" content="제이씨메디칼, JC메디칼, jcmedical, 오스테오시스, 마인드레이, 골밀도, 충격파, 초음파, 심전도, 환자감시모니터, 중고 초음파, 토르리프팅">
  <meta name="robots" content="index, follow">
  <meta property="og:type" content="website">
  <meta property="og:title" content="제이씨메디칼(JCMedical)">
  <meta property="og:description" content="골밀도, 충격파, 초음파, 심전도, 환자감시모니터, 중고 초음파, 토르리프팅">
  <meta property="og:url" content="https://www.jcmedical.com/">
  <meta property="og:image" content="https://www.jcmedical.com/img/logo.png">
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "MedicalBusiness",
    "name": "제이씨메디칼 (JCMedical, JC메디칼)",
    "description": "제이씨메디칼(JC메디칼) 오스테오시스, 마인드레이 전문 대리점",
    "url": "https://www.jcmedical.com/",
    "telephone": "010-9474-6127",
    "address": {
      "@type": "PostalAddress",
	  "postalCode": "13647",
	  "addressRegion": "경기",
      "addressLocality": "성남시 수정구",
	  "streetAddress": "위례서로24, 위례행복빌딩3층 303호"
    },
    "keywords": "제이씨메디칼, JC메디칼, jcmedical, 오스테오시스, 마인드레이, 골밀도, 충격파, 초음파, 심전도, 환자감시모니터, 중고 초음파, 토르리프팅"
  }
  </script>
  <meta name="author" content="JCMedical">  
  <link rel="canonical" href="https://www.jcmedical.com/">
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/products.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/app.js" defer></script>
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
</head>
<body>
<script>
async function checkAuth() {
    // 이제 supabaseClient가 로드된 후에 실행되므로 에러가 나지 않습니다.
    const { data: { user } } = await supabaseClient.auth.getUser();
    console.log(user);
    
    if (!user) {
        alert("권한이 없습니다. 로그인이 필요합니다.");
        location.href = 'index.html';
    }
}

// 1. DOMContentLoaded를 사용하여 app.js(defer)가 실행된 직후에 작동하게 합니다.
window.addEventListener('DOMContentLoaded', () => {
    checkAuth();
    
    // 기존의 제품 데이터를 가져오는 로직도 아마 여기 있거나 이 밑에 있을 거예요.
    // loadProductData(); 
});
</script>
<header>
    <div class="header-inner">
        <a href="index.html" class="logo">
            <img src="img/logo_long.png" alt="제이씨메디칼(jc메디칼) 로고">
        </a>
        
        <nav class="nav">
            <ul class="nav-menu">
                <li class="nav-item">
					<a href="#">회사소개 <span class="icon-plus">+</span><span class="icon-minus">-</span></a>
					<ul class="mobile-sub">
						<li><a href="about.html">인사말</a></li>
						<li><a href="about.html#location">오시는길</a></li>
					</ul>
				</li>
                <li class="nav-item">
					<a href="#">PRODUCT <span class="icon-plus">+</span><span class="icon-minus">-</span></a>
					<ul class="mobile-sub">
						<li><a href="products.html?cat=bmd">골밀도진단기 (BMD)</a></li>
						<li><a href="products.html?cat=eswt">체외충격파 (ESWT)</a></li>
						<li><a href="products.html?cat=ultrasound">초음파진단기 (Ultrasound / SONO)</a></li>
						<li><a href="products.html?cat=freq">고주파기기 (TORR RF)</a></li>
						<li><a href="products.html?cat=used">중고장비</a></li>
					</ul>
				</li>
                <li class="nav-item">
					<a href="notice.html">공지사항</a>
				</li>
                <li class="nav-item">
					<a href="contact.html">문의하기</a>
				</li>
            </ul>
        </nav>
		
		<div class="partner-logo">
			<div class="vendor-logos">
				<img src="img/os_logo.png" alt="OsteoSys">
				<img src="img/min_logo.png" alt="Mindray">
			</div>
			<a href="http://pf.kakao.com/_pdvjn/chat" target="_blank"><img src="img/kakao.png" alt="kakao"></a>
			<a href="https://blog.naver.com/jcmedical0826" target="_blank"><img src="img/blog.png" alt="naver blog"></a>
		</div>
        
        <div class="hamburger">☰</div>
    </div>

    <div class="mega-menu">
        <div class="mega-inner">
            <div class="mega-col">
                <a href="about.html">인사말</a>
				<a href="about.html#location">오시는길</a>
            </div>
        
            <div class="mega-col">
				<a href="products.html?cat=bmd">골밀도진단기 (BMD)</a>
				<a href="products.html?cat=eswt">체외충격파 (ESWT)</a>
				<a href="products.html?cat=ultrasound">초음파진단기<br>(Ultrasound / SONO)</a>
				<a href="products.html?cat=freq">고주파기기 (TORR RF)</a>
                <a href="products.html?cat=used">중고장비</a>
            </div>
        
            <div class="mega-col">
                <a href="notice.html">공지사항</a>
            </div>
        
            <div class="mega-col">
                <a href="contact.html">문의하기</a>
            </div>
        </div>
    </div>
</header>

<section class="sub-visual">
    <div class="visual-text">
        <h2>PRODUCT</h2>
        <p>JC Medical이 제안하는 최첨단 의료 솔루션을 확인하세요.</p>
    </div>
</section>

<div class="content-wrapper">
	<div class="write-container">
		<div class="write-header">
			<h3>제품 정보 수정</h3>
		</div>
	
		<form id="editForm" class="write-form">
			<div class="form-grid">
				<div class="input-group">
					<label for="category">카테고리</label>
					<select id="category" required>
						<option value="freq">고주파</option>
						<option value="used">중고장비</option>
					</select>
				</div>
				<div class="input-group">
					<label for="title">제품명</label>
					<input type="text" id="title" placeholder="제품 모델명을 입력하세요" required>
				</div>
				<div class="input-group full-width">
					<label for="url">상세 연결 URL (외부 링크)</label>
					<input type="url" id="url" placeholder="https://example.com">
				</div>
			</div>
	
			<div class="input-group">
				<label>제품 이미지 (변경 시에만 새로 업로드)</label>
				<div class="image-upload-box" id="dropZone">
					<input type="file" id="imageInput" accept="image/*" hidden>
					
					<div id="imagePreview" class="preview-container">
						<img src="" alt="미리보기" id="previewImg">
						<p class="change-info">이미지를 클릭하여 변경할 수 있습니다.</p>
					</div>
				</div>
			</div>
	
			<div class="input-group">
				<label>제품 상세 설명</label>
				<div id="editor-container">
					<div id="editor" style="height: 300px;"></div>
				</div>
			</div>
	
			<div class="form-actions">
				<button type="button" class="btn-cancel" onclick="history.back()">취소</button>
				<button type="submit" class="btn-submit" id="submitBtn">수정 완료</button>
			</div>
		</form>
	</div>
</div>
    </section>

    <script>
	// 1. 초기 설정 (Quill)
const quill = new Quill('#editor', {
    theme: 'snow',
    modules: {
        toolbar: [['bold', 'italic', 'underline'], [{'header': [1, 2, false]}], ['link', 'image'], ['clean']]
    }
});

let compressedImageBlob = null;
let currentImageUrl = ""; // 기존 이미지 URL 보관용

// URL에서 제품 ID 가져오기
const urlParams = new URLSearchParams(window.location.search);
const productId = urlParams.get('id');

if (!productId) {
    alert("잘못된 접근입니다.");
    location.href = 'products.html';
}

// 2. 데이터 불러오기 함수
async function fetchProductData() {
    try {
        const { data, error } = await supabaseClient
            .from('products')
            .select('*')
            .eq('id', productId)
            .single();

        if (error) throw error;

        // 폼에 데이터 채우기
        document.getElementById('category').value = data.category;
        document.getElementById('title').value = data.title;
        document.getElementById('url').value = data.url;
        quill.root.innerHTML = data.content;
        
        // 이미지 미리보기 세팅
        if (data.image_url) {
            currentImageUrl = data.image_url;
            document.getElementById('previewImg').src = data.image_url;
        }
    } catch (err) {
        console.error(err);
        alert("데이터를 불러오는데 실패했습니다.");
    }
}

// 3. 이미지 리사이징 (등록 페이지와 동일 로직)
async function resizeImage(file) {
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (ev) => {
            const img = new Image();
            img.src = ev.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;
                const maxWidth = 1200;

                if (width > maxWidth) {
                    height = (maxWidth / width) * height;
                    width = maxWidth;
                }

                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);

                canvas.toBlob((blob) => resolve(blob), 'image/jpeg', 0.75);
            };
        };
    });
}

// 4. 이미지 선택 이벤트
const imageInput = document.getElementById('imageInput');
const previewImg = document.getElementById('previewImg');

document.getElementById('dropZone').onclick = () => imageInput.click();

imageInput.onchange = async (e) => {
    const file = e.target.files[0];
    if (file) {
        compressedImageBlob = await resizeImage(file);
        previewImg.src = URL.createObjectURL(compressedImageBlob);
    }
};

// 5. 수정 데이터 제출 (Update)
document.getElementById('editForm').onsubmit = async (e) => {
    e.preventDefault();
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.innerText = "업데이트 중...";
    submitBtn.disabled = true;

    try {
        let finalImageUrl = currentImageUrl;

        // 새로운 이미지가 선택된 경우에만 업로드
        if (compressedImageBlob) {
			//기존 이미지 삭제
			if (currentImageUrl) {
				const urlParts = currentImageUrl.split('/public/');
				if (urlParts.length > 1) {
					const fullPath = urlParts[1];              // products_img/파일명.jpg
					const bucketName = fullPath.split('/')[0]; // products_img
					const filePath = fullPath.split('/').slice(1).join('/');
		
					const { error: removeError } = await supabaseClient
						.storage
						.from(bucketName)
						.remove([filePath]); // ⭐ 배열
			
					if (removeError) {
						console.warn('기존 이미지 삭제 실패:', removeError.message);
					}
				}
			}
		
            const fileName = `prod_update_${Date.now()}.jpg`;
            const { data: uploadData, error: uploadError } = await supabaseClient
                .storage
                .from('products_img')
                .upload(fileName, compressedImageBlob);

            if (uploadError) throw uploadError;

            const { data: publicUrlData } = supabaseClient
                .storage
                .from('products_img')
                .getPublicUrl(fileName);
            
            finalImageUrl = publicUrlData.publicUrl;
        }

        // DB 업데이트
        const { error: updateError } = await supabaseClient
            .from('products')
            .update({
                category: document.getElementById('category').value,
                title: document.getElementById('title').value,
                url: document.getElementById('url').value,
                image_url: finalImageUrl,
                content: quill.root.innerHTML
            })
            .eq('id', productId);

        if (updateError) throw updateError;

        alert('수정이 완료되었습니다.');
        location.href = 'products.html';

    } catch (err) {
        console.error(err);
        alert('수정 실패: ' + err.message);
    } finally {
        submitBtn.innerText = "수정 완료";
        submitBtn.disabled = false;
    }
};

// 페이지 로드 시 데이터 호출
window.addEventListener('DOMContentLoaded', fetchProductData);
    </script>	    
</div>
<footer class="site-footer">
  <div class="footer-inner">

    <div class="footer-logo-area">
      <img src="img/logo.png" alt="JC Medical" class="footer-logo">
    </div>
	
	<div class="footer-text-area">
      <p class="footer-info">
        Address: 경기도 성남시 수정구 위례서로24, 위례행복빌딩3층 303호<br>
        Tel: 070-4651-5088 | 010-9474-6127 <br>
        E-mail: jcmedi0826@naver.com<Br>
		사업자번호: 512-13-30045
      </p>
	  
	  <div class="footer-links">
      <a href="policy.html?tab=terms">이용약관</a>
      <span class="divider">|</span>
      <a href="policy.html?tab=privacy">개인정보처리방침</a>
    </div>
    </div>

  </div>

  <div class="footer-bottom">
    © 2025 JC Medical. All rights reserved.
  </div>
</footer>
</body>
</html>