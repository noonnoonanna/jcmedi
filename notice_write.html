<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JCMedical</title>  
  <meta name="description" content="JCMedical Mindray 전문 대리점 초음파기기, 심전도, 환자감시모니터 등 의료 현장의 최적 솔루션을 제공합니다.">  
  <meta name="robots" content="index, follow">
  <meta name="author" content="JCMedical">  
  <link rel="canonical" href="https://www.jcmedical.com/">
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/products.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/app.js" defer></script>
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
</head>
<body>
<script>
async function checkAuth() {
    // 이제 supabaseClient가 로드된 후에 실행되므로 에러가 나지 않습니다.
    const { data: { user } } = await supabaseClient.auth.getUser();
    console.log(user);
    
    if (!user) {
        alert("권한이 없습니다. 로그인이 필요합니다.");
        location.href = 'index.html';
    }
}

// 1. DOMContentLoaded를 사용하여 app.js(defer)가 실행된 직후에 작동하게 합니다.
window.addEventListener('DOMContentLoaded', () => {
    checkAuth();
    
    // 기존의 제품 데이터를 가져오는 로직도 아마 여기 있거나 이 밑에 있을 거예요.
    // loadProductData(); 
});
</script>
<style>
.write-form .form-grid{grid-template-columns:1fr;}
</style>
<header>
    <div class="header-inner">
        <a href="index.html" class="logo">
            <img src="img/logo_long.png" alt="JC Medical">
        </a>
        
        <nav class="nav">
            <ul class="nav-menu">
                <li class="nav-item">
					<a href="#">회사소개 <span class="icon-plus">+</span><span class="icon-minus">-</span></a>
					<ul class="mobile-sub">
						<li><a href="about.html">인사말</a></li>
						<li><a href="about.html#location">오시는길</a></li>
					</ul>
				</li>
                <li class="nav-item">
					<a href="#">PRODUCT <span class="icon-plus">+</span><span class="icon-minus">-</span></a>
					<ul class="mobile-sub">
						<li><a href="products.html?cat=ultrasound">초음파진단기</a></li>
						<li><a href="products.html?cat=freq">고주파기기</a></li>
						<li><a href="products.html?cat=used">중고장비</a></li>
					</ul>
				</li>
                <li class="nav-item">
					<a href="notice.html">공지사항</a>
				</li>
                <li class="nav-item">
					<a href="contact.html">문의하기</a>
				</li>
            </ul>
        </nav>
		
		<div class="partner-logo">
			<img src="img/min_logo.png" alt="Mindray">
			<a href="http://pf.kakao.com/_pdvjn/chat" target="_blank"><img src="img/kakao.png" alt="kakao"></a>
			<a href="https://blog.naver.com/jcmedical0826" target="_blank"><img src="img/blog.png" alt="naver blog"></a>
		</div>
        
        <div class="hamburger">☰</div>
    </div>

    <div class="mega-menu">
        <div class="mega-inner">
            <div class="mega-col">
                <a href="about.html">인사말</a>
				<a href="about.html#location">오시는길</a>
            </div>
        
            <div class="mega-col">
                <a href="products.html?cat=ultrasound">초음파진단기</a>
				<a href="products.html?cat=freq">고주파기기</a>
                <a href="products.html?cat=used">중고장비</a>
            </div>
        
            <div class="mega-col">
                <a href="notice.html">공지사항</a>
            </div>
        
            <div class="mega-col">
                <a href="contact.html">문의하기</a>
            </div>
        </div>
    </div>
</header>

<section class="sub-visual">
    <div class="visual-text">
        <h2>NOTICE</h2>
        <p>JC Medical의 끊임없는 도전과 변화, 이곳에서 확인하세요.</p>
    </div>
</section>

<div class="content-wrapper">
	<div class="write-container">
		<div class="write-header">
			<h3>공지사항 등록하기</h3>
		</div>
	
		<form id="noticeForm" class="write-form">
			<div class="form-grid">
				<div class="input-group">
					<label for="title">제목</label>
					<input type="text" id="title" placeholder="제목을 입력하세요" required>
				</div>
			</div>
	
			<div class="input-group">
				<label>내용</label>
				<div id="editor-container">
					<div id="editor" style="height: 960px;"></div>
				</div>
			</div>
	
			<div class="form-actions">
				<button type="button" class="btn-cancel" onclick="history.back()">취소</button>
				<button type="submit" class="btn-submit" id="submitBtn">등록하기</button>
			</div>
		</form>
	</div>
</div>
    </section>

    <script>
	// 1. 이미지 압축 함수
async function compressImage(file) {
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (event) => {
            const img = new Image();
            img.src = event.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;

                const maxWidth = 1000;
                if (width > maxWidth) {
                    height = (maxWidth / width) * height;
                    width = maxWidth;
                }

                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');

                // --- 추가된 부분: 배경을 흰색으로 채우기 (PNG 투명도 방지) ---
                ctx.fillStyle = "#fff"; 
                ctx.fillRect(0, 0, width, height);
                // -------------------------------------------------------

                ctx.drawImage(img, 0, 0, width, height);

                // 'image/jpeg'로 설정했으므로 여기서 JPG 변환이 일어납니다.
                canvas.toBlob((blob) => {
                    resolve(blob);
                }, 'image/jpeg', 0.7); 
            };
        };
    });
}

        // 2. Quill 에디터 설정 및 이미지 핸들러
        const quill = new Quill('#editor', {
            theme: 'snow',
            modules: {
                toolbar: {
                    container: [
                        [{ 'header': [1, 2, 3, false] }],
                        ['bold', 'italic', 'underline'],
                        ['image', 'link'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }]
                    ],
                    handlers: {
                        image: imageHandler
                    }
                }
            }
        });

        async function imageHandler() {
            const input = document.createElement('input');
            input.setAttribute('type', 'file');
            input.setAttribute('accept', 'image/*');
            input.click();

            input.onchange = async () => {
                const file = input.files[0];
                if (!file) return;

                // 로딩 표시 (선택사항)
                console.log('압축 및 업로드 중...');

                // 압축 실행
                const compressedBlob = await compressImage(file);
                const fileName = `notice/${Date.now()}_${file.name.split('.')[0]}.jpg`;

                // Supabase Storage 업로드
                const { data, error } = await supabaseClient.storage
                    .from('notice_img')
                    .upload(fileName, compressedBlob, {
                        contentType: 'image/jpeg'
                    });

                if (error) {
                    alert('업로드 실패: ' + error.message);
                    return;
                }

                // 이미지 URL 가져와서 에디터에 삽입
                const { data: { publicUrl } } = supabaseClient.storage
                    .from('notice_img')
                    .getPublicUrl(fileName);

                const range = quill.getSelection();
                quill.insertEmbed(range.index, 'image', publicUrl);
            };
        }

        // 3. 게시글 저장 함수
        async function savePost() {
            const title = document.getElementById('title').value;
            const content = quill.root.innerHTML; // HTML 통째로 저장

            if (!title || content === '<p><br></p>') {
                alert('제목과 내용을 입력해주세요.');
                return;
            }

            // 첫 번째 이미지를 대표 이미지로 추출 (썸네일 용도)
            const imgTag = quill.root.querySelector('img');
            const thumbnailUrl = imgTag ? imgTag.getAttribute('src') : null;

            const { error } = await supabase
                .from('notices')
                .insert([{ 
                    title, 
                    content, 
                    image_url: thumbnailUrl, // 리스트에서 보여줄 썸네일
                    created_at: new Date() 
                }]);

            if (error) {
                alert('저장 실패: ' + error.message);
            } else {
                alert('등록되었습니다.');
                location.href = 'notice.html';
            }
        }
    </script>	    
</div>
<footer class="site-footer">
  <div class="footer-inner">

    <div class="footer-logo-area">
      <img src="img/logo.png" alt="JC Medical" class="footer-logo">
    </div>
	
	<div class="footer-text-area">
      <p class="footer-info">
        Address: 경기도 성남시 수정구 위례서로24, 위례행복빌딩3층 303호<br>
        Tel: 070-4651-5088 | 010-9474-6127 <br>
        E-mail: jcmedi0826@naver.com<Br>
		사업자번호: 512-13-30045
      </p>
	  
	  <div class="footer-links">
      <a href="policy.html?tab=terms">이용약관</a>
      <span class="divider">|</span>
      <a href="policy.html?tab=privacy">개인정보처리방침</a>
    </div>
    </div>

  </div>

  <div class="footer-bottom">
    © 2025 JC Medical. All rights reserved.
  </div>
</footer>
</body>
</html>